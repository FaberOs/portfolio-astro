---
import { GITHUB_USER, BASE_URL } from "astro:env/server";
import { githubFetch } from "@lib/github";
import Layout from "@layouts/Layout.astro";
import LinkIcon from "@icons/LinkIcon.astro";
import ProjectReadme from "@components/ProjectReadme.astro";
import ProjectReadmeSkeleton from "@components/skeletons/ProjectReadmeSkeleton.astro";

const { id } = Astro.params;

type Project = {
  name: string;
  html_url: string;
  description: string | null;
  language: string | null;
  updated_at: string;
  created_at: string;
  homepage: string | null;
};

let project: Project | null = null;
let rateLimited = false;

const result = await githubFetch<Project>(`${BASE_URL}/repos/${GITHUB_USER}/${id}`);
if (result.ok) {
  project = result.data;
} else if (result.rateLimited) {
  rateLimited = true;
} else {
  return Astro.rewrite('/404');
}

let languages: string[] = [];
if (project) {
  const langResult = await githubFetch<Record<string, number>>(
    `${BASE_URL}/repos/${GITHUB_USER}/${id}/languages`
  );
  if (langResult.ok) {
    languages = Object.keys(langResult.data);
  }
}

const deviconMap: Record<string, string> = {
  JavaScript: "devicon-javascript-plain colored",
  TypeScript: "devicon-typescript-plain colored",
  Python: "devicon-python-plain colored",
  Java: "devicon-java-plain colored",
  Ruby: "devicon-ruby-plain colored",
  Kotlin: "devicon-kotlin-plain colored",
  CSS: "devicon-css3-plain colored",
  HTML: "devicon-html5-plain colored",
  React: "devicon-react-original colored",
  NextJS: "devicon-nextjs-plain",
  Astro: "devicon-astro-plain colored",
};

const filteredLanguages = languages.filter((lang) => deviconMap[lang]);
---

<Layout title={project?.name ?? id ?? 'Proyecto'}>
  <div class="max-w-3xl mx-auto py-10 px-6">
    {rateLimited ? (
      <div data-api-error="rate-limit" class="text-center py-20">
        <span class="text-5xl">⏳</span>
        <h1 class="text-2xl font-bold text-light-900 dark:text-[#E5E3E5] mt-6">Límite de solicitudes alcanzado</h1>
        <p class="mt-3 text-amber-600 dark:text-amber-400 text-sm max-w-md mx-auto">
          La API de GitHub ha alcanzado el límite de solicitudes. Intenta recargar la página en unos minutos.
        </p>
        <a
          href="/"
          class="inline-block mt-6 px-4 py-2 border border-light-400 dark:border-dark-300 text-light-450 dark:text-[#C8C6C8] rounded-md hover:bg-light-200 dark:hover:bg-dark-500 transition"
        >
          Volver al inicio
        </a>
      </div>
    ) : project && (
      <Fragment>
        <h1 class="text-3xl font-bold text-light-900 dark:text-[#E5E3E5]">
          {project.name}
        </h1>
        <p class="text-sm text-light-500 dark:text-[#A0A0A0] mt-2">
          {new Date(project.created_at).toLocaleDateString()}
        </p>
    {
      project.description && (
        <p class="mt-4 text-light-600 dark:text-[#C8C6C8] text-base">
          {project.description}
        </p>
      )
    }
    {
      project.homepage && (
        <a
          href={project.homepage}
          target="_blank"
          class="flex items-center gap-2 mt-4 text-sm"
        >
          <LinkIcon className="text-light-500 dark:text-dark-100" />
          <span class="font-medium text-blue-700 dark:text-blue-500">
            {project.homepage}
          </span>
        </a>
      )
    }
    <div class="mt-6 text-light-500 dark:text-dark-300 text-sm">
      {
        filteredLanguages.length > 0 && (
          <div class="mt-4">
            <div class="flex gap-4 mt-2">
              {filteredLanguages.map((lang) => (
                <div class="flex items-center gap-2">
                  <i
                    class={`${deviconMap[lang]} text-base ${lang === "NextJS" ? "dark:text-light-50" : ""}`}
                    aria-hidden="true"
                  />
                  <span class="text-sm text-light-500 dark:text-[#C8C6C8]">
                    {lang}
                  </span>
                </div>
              ))}
            </div>
          </div>
        )
      }
    </div>
    <a
      href={project.html_url}
      target="_blank"
      class="inline-block mt-6 px-4 py-2 border border-light-400 dark:border-dark-300 text-light-450 dark:text-[#C8C6C8] rounded-md hover:bg-light-200 dark:hover:bg-dark-500 transition"
    >
      Ver en GitHub
    </a>

    <ProjectReadme projectId={id!} server:defer>
      <ProjectReadmeSkeleton slot="fallback" />
    </ProjectReadme>
      </Fragment>
    )}
  </div>
</Layout>

<style>
  @import url("https://cdn.jsdelivr.net/gh/devicons/devicon@latest/devicon.min.css");
</style>
