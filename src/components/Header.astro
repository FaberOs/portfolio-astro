---
import ThemeToggle from "./ThemeToggle.astro";
import VSIcon from "@icons/VSIcon.astro";
import MoreIcon from "@icons/MoreIcon.astro";
import ArrowLeftIcon from "@icons/ArrowLeftIcon.astro";
import ArrowRightIcon from "@icons/ArrowRightIcon.astro";
import SearchIcon from "@icons/SearchIcon.astro";
import MinimizeIcon from "@icons/MinimizeIcon.astro";
import RestoreIcon from "@icons/RestoreIcon.astro";
import CloseIcon from "@icons/CloseIcon.astro";
import MinimizedOverlay from "./MinimizedOverlay.astro";

const navOptions = ["File", "Edit", "Selection", "View", "Go"];
import { GITHUB_USER } from "astro:env/server";
---

<header
  class="bg-light-200 dark:bg-dark-700 w-full flex justify-between items-center border-b border-light-300 dark:border-dark-800"
>
  <div class="flex items-center ml-3">
    <VSIcon />
    <nav class="text-light-400 dark:text-dark-300 text-sm ml-2 hidden lg:flex">
      {
        navOptions.map((option) => (
          <span
            class="px-2 py-1 rounded-[4px] transition-colors duration-200 
            hover:bg-light-300 dark:hover:bg-[#333234] 
            hover:text-light-500 dark:hover:text-dark-50"
          >
            {option}
          </span>
        ))
      }
    </nav>
    <div
      class="group px-2 py-1 rounded-[4px] transition-colors duration-200
      hover:bg-light-300 dark:hover:bg-[#333234] hidden lg:flex"
    >
      <MoreIcon
        className="text-light-400 dark:text-dark-300 group-hover:text-light-500 dark:group-hover:text-dark-50"
        height="16"
      />
    </div>
  </div>

  <div class="flex items-center w-full max-w-[600px] justify-center space-x-2">
    <div class="hidden md:flex items-center ml-3">
      <div
        id="btn-back"
        role="button"
        tabindex="0"
        title="Atrás"
        class="nav-btn px-2 py-1 rounded-[4px] transition-all duration-200"
      >
        <ArrowLeftIcon
          className="text-light-400 dark:text-dark-300"
          height="16"
        />
      </div>
      <div
        id="btn-forward"
        role="button"
        tabindex="0"
        title="Adelante"
        class="nav-btn px-2 py-1 rounded-[4px] transition-all duration-200"
      >
        <ArrowRightIcon
          className="text-light-400 dark:text-dark-300"
          height="16"
        />
      </div>
    </div>

    <div
      class="group flex items-center justify-center text-light-400 dark:text-dark-300 text-xs border
      border-light-50 dark:border-dark-600 px-2 py-1 rounded-[4px] w-full xl:max-w-[600px] lg:max-w-[300px]
      hover:bg-light-50 dark:hover:bg-[#2d2a2e] hover:border-light-300 dark:hover:border-dark-500
      hover:text-light-500 dark:hover:text-dark-100 transition-colors duration-200 cursor-pointer"
    >
      <SearchIcon
        className="text-light-400 dark:text-dark-300 group-hover:text-light-500 dark:group-hover:text-dark-100"
        height="14"
      />
      <span>Portfolio-{GITHUB_USER}</span>
    </div>
  </div>

  <div class="lg:hidden">
    <ThemeToggle />
  </div>

  <div class="hidden sm:flex items-center">
    <button
      id="btn-minimize"
      title="Minimizar"
      class="py-2 px-3 transition-colors duration-200 hover:bg-light-300 dark:hover:bg-[#333234] cursor-pointer"
    >
      <MinimizeIcon
        width="16"
        height="16"
        className="text-light-400 dark:text-dark-300"
      />
    </button>
    <button
      id="btn-restore"
      title="Restaurar"
      class="py-2 px-3 transition-colors duration-200 hover:bg-light-300 dark:hover:bg-[#333234] cursor-pointer"
    >
      <RestoreIcon
        width="16"
        height="16"
        className="text-light-400 dark:text-dark-300"
      />
    </button>
    <button
      id="btn-close"
      title="Cerrar"
      class="group py-2 px-3 transition-colors duration-200 hover:bg-red-500 dark:hover:bg-red-600 cursor-pointer"
    >
      <CloseIcon
        width="16"
        height="16"
        className="text-light-400 dark:text-dark-300 dark:group-hover:text-white group-hover:text-white"
      />
    </button>
  </div>
</header>

<MinimizedOverlay />

<script>
  // ═══════════════════════════════════════════════════════════════
  //  Navigation: Back / Forward with history tracking
  // ═══════════════════════════════════════════════════════════════
  const NAV_KEY = "__navIdx";
  const btnBack = document.getElementById("btn-back");
  const btnFwd = document.getElementById("btn-forward");

  const perfNav = performance.getEntriesByType("navigation")[0] as PerformanceNavigationTiming | undefined;
  const isTraversal = perfNav?.type === "back_forward";

  let curIdx: number;
  let maxIdx: number;

  if (isTraversal && history.state?.[NAV_KEY] !== undefined) {
    curIdx = history.state[NAV_KEY];
    maxIdx = parseInt(sessionStorage.getItem("__navMax") || "0");
  } else {
    const prev = parseInt(sessionStorage.getItem("__navCur") || "-1");
    curIdx = prev + 1;
    maxIdx = curIdx;
    history.replaceState({ ...history.state, [NAV_KEY]: curIdx }, "");
  }

  sessionStorage.setItem("__navCur", String(curIdx));
  sessionStorage.setItem("__navMax", String(maxIdx));

  function setNavStates() {
    const canBack = curIdx > 0;
    const canFwd = curIdx < maxIdx;

    if (btnBack) {
      btnBack.classList.toggle("nav-btn--enabled", canBack);
      btnBack.classList.toggle("nav-btn--disabled", !canBack);
      btnBack.setAttribute("aria-disabled", String(!canBack));
      btnBack.setAttribute("tabindex", canBack ? "0" : "-1");
    }
    if (btnFwd) {
      btnFwd.classList.toggle("nav-btn--enabled", canFwd);
      btnFwd.classList.toggle("nav-btn--disabled", !canFwd);
      btnFwd.setAttribute("aria-disabled", String(!canFwd));
      btnFwd.setAttribute("tabindex", canFwd ? "0" : "-1");
    }
  }

  setNavStates();

  btnBack?.addEventListener("click", () => {
    if (curIdx > 0) history.back();
  });
  btnFwd?.addEventListener("click", () => {
    if (curIdx < maxIdx) history.forward();
  });
</script>

<style>
  .nav-btn--enabled {
    cursor: pointer;
    opacity: 1;
  }

  .nav-btn--enabled:hover {
    background-color: var(--color-light-300);
  }

  :global(.dark) .nav-btn--enabled:hover {
    background-color: #333234;
  }

  .nav-btn--disabled {
    opacity: 0.3;
    cursor: default;
    pointer-events: none;
  }
</style>
