---
import { GITHUB_USER_URL } from "astro:env/server";
import { githubFetch } from "@lib/github";
import ProjectCard from "@components/ProjectCard.astro";
import RepoIcon from "@icons/RepoIcon.astro";

type Project = {
  name: string;
  html_url: string;
  description: string | null;
  language: string | null;
  updated_at: string;
  created_at: string;
  homepage: string | null;
};

let projects: Project[] = [];
let rateLimited = false;

const result = await githubFetch<Project[]>(`${GITHUB_USER_URL}/repos`);
if (result.ok) {
  projects = Array.isArray(result.data) ? result.data : [];
} else {
  rateLimited = result.rateLimited;
}

projects = projects.sort(
  (a, b) =>
    new Date(b.created_at).getTime() - new Date(a.created_at).getTime()
);
---

<section class="w-full max-w-5xl mx-auto px-4">
  <div class="flex items-center gap-2 text-light-600 dark:text-dark-100 mb-6">
    <RepoIcon width="20" height="20" />
    <h2 class="text-xl font-semibold">Todos los proyectos</h2>
  </div>

  {rateLimited ? (
    <div data-api-error="rate-limit" class="text-center py-12">
      <span class="text-3xl">⏳</span>
      <p class="mt-3 text-amber-600 dark:text-amber-400 text-sm">Límite de solicitudes alcanzado. Recarga en unos minutos.</p>
    </div>
  ) : projects.length === 0 ? (
    <div data-api-error="error" class="text-center py-12">
      <p class="text-light-400 dark:text-dark-300 text-sm">No se pudieron cargar los proyectos.</p>
    </div>
  ) : (
    <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4">
      {
        projects.map((project) => (
          <ProjectCard
            name={project.name}
            description={project.description}
            language={project.language}
            homepage={project.homepage}
            createdAt={project.created_at}
          />
        ))
      }
    </div>
  )}
</section>
